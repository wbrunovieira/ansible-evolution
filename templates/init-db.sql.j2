-- Evolution API PostgreSQL Initialization Script
-- Generated by Ansible

-- Create user if not exists (for safety)
DO
$$
BEGIN
  IF NOT EXISTS (SELECT FROM pg_catalog.pg_user WHERE usename = '{{ postgres_user }}') THEN
    CREATE USER {{ postgres_user }} WITH PASSWORD '{{ vault_postgres_password }}';
  END IF;
END
$$;

-- Create database if not exists
SELECT 'CREATE DATABASE {{ postgres_db }} OWNER {{ postgres_user }}'
WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = '{{ postgres_db }}');

-- Grant all privileges to user
GRANT ALL PRIVILEGES ON DATABASE {{ postgres_db }} TO {{ postgres_user }};

-- Connect to the database for further setup
\c {{ postgres_db }};

-- Create schema if not exists
CREATE SCHEMA IF NOT EXISTS public;

-- Grant privileges
GRANT ALL ON SCHEMA public TO {{ postgres_user }};
GRANT ALL ON SCHEMA public TO public;

-- Create extensions if needed
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pgcrypto";

-- Set default search path
ALTER DATABASE {{ postgres_db }} SET search_path TO public;

-- Ensure user owns the schema
ALTER SCHEMA public OWNER TO {{ postgres_user }};

-- Create initial tables will be handled by Evolution API migrations